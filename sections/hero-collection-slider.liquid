<div
  data-section-id="{{ section.id }}"
  data-section-type="hero-collections"
  class="fr-hero-section">

  {%- if section.blocks.size > 0 -%}
    {%- assign has_images = false -%}
    {%- for block in section.blocks -%}
      {%- if block.type == 'collection_block' and block.settings.hero_image != blank -%}
        {%- assign has_images = true -%}
        {%- break -%}
      {%- endif -%}
    {%- endfor -%}
    
    {%- if has_images or section.settings.default_image != blank or section.settings.default_video != blank -%}
  <div class="fr-hero-wrapper{% if section.settings.desktop_height == '100vh-with-collections' %} fr-hero-fullscreen-with-collections{% endif %}">
      
      <!-- Hero Media Container -->
      <div class="fr-hero-media-container" 
           data-height-desktop="{{ section.settings.desktop_height }}"
           data-height-mobile="{{ section.settings.mobile_height }}">
        
        {%- comment -%} Default Media {%- endcomment -%}
        {%- if section.settings.default_image != blank or section.settings.default_video != blank -%}
          <div class="fr-hero-media active" data-media-id="default">
            
            {%- if section.settings.default_link != blank and section.settings.link_type != 'button' -%}
              <a href="{{ section.settings.default_link }}" class="fr-hero-link-overlay" aria-label="{{ section.settings.default_title | default: 'Hero link' }}"></a>
            {%- endif -%}
            
            {%- if section.settings.default_video != blank -%}
              <video class="fr-hero-video" autoplay muted loop playsinline>
                <source src="{{ section.settings.default_video }}" type="video/mp4">
              </video>
              {%- if section.settings.default_video_mobile != blank -%}
                <video class="fr-hero-video fr-hero-video--mobile" autoplay muted loop playsinline>
                  <source src="{{ section.settings.default_video_mobile }}" type="video/mp4">
                </video>
              {%- endif -%}
            {%- elsif section.settings.default_image != blank -%}
              <div class="fr-hero-image fr-hero-image--desktop">
                {%- render 'image-element',
                  img: section.settings.default_image,
                  img_width: 2400,
                  loading: false
                -%}
              </div>
              <div class="fr-hero-image fr-hero-image--mobile">
                {%- if section.settings.default_image_mobile != blank -%}
                  {%- render 'image-element',
                    img: section.settings.default_image_mobile,
                    img_height: 800,
                    loading: false
                  -%}
                {%- else -%}
                  {%- render 'image-element',
                    img: section.settings.default_image,
                    img_height: 800,
                    loading: false
                  -%}
                {%- endif -%}
              </div>
            {%- endif -%}
            
            {%- if section.settings.default_overlay_opacity > 0 -%}
              <div class="fr-hero-overlay" style="opacity: {{ section.settings.default_overlay_opacity | divided_by: 100.0 }}"></div>
            {%- endif -%}
            
            {%- render 'hero-content',
              title: section.settings.default_title,
              subtitle: section.settings.default_subtitle,
              text_color: section.settings.default_text_color,
              text_alignment: section.settings.default_text_alignment,
              cta_text: section.settings.cta_text,
              cta_link: section.settings.default_link,
              cta_style: section.settings.cta_style,
              cta_bg_color: section.settings.cta_bg_color,
              cta_text_color: section.settings.cta_text_color,
              cta_border_color: section.settings.cta_border_color,
              link_type: section.settings.link_type,
              content_position: section.settings.content_vertical_position,
              content_position_mobile: section.settings.content_vertical_position_mobile,
              title_font_weight: section.settings.title_font_weight
            -%}
          </div>
        {%- endif -%}
        
        {%- comment -%} Collection Images {%- endcomment -%}
        {%- for block in section.blocks -%}
          {%- if block.type == 'collection_block' and block.settings.hero_image != blank -%}
            <div class="fr-hero-media" data-media-id="{{ block.id }}">
              <div class="fr-hero-image fr-hero-image--desktop">
                {%- render 'image-element',
                  img: block.settings.hero_image,
                  img_width: 2400,
                  loading: true
                -%}
              </div>
              <div class="fr-hero-image fr-hero-image--mobile">
                {%- if block.settings.hero_image_mobile != blank -%}
                  {%- render 'image-element',
                    img: block.settings.hero_image_mobile,
                    img_height: 800,
                    loading: true
                  -%}
                {%- else -%}
                  {%- render 'image-element',
                    img: block.settings.hero_image,
                    img_height: 800,
                    loading: true
                  -%}
                {%- endif -%}
              </div>
              
              {%- if block.settings.overlay_opacity > 0 -%}
                <div class="fr-hero-overlay" style="opacity: {{ block.settings.overlay_opacity | divided_by: 100.0 }}"></div>
              {%- endif -%}
              
              {%- render 'hero-content',
                title: block.settings.hero_title,
                subtitle: block.settings.hero_subtitle,
                text_color: block.settings.hero_text_color,
                text_alignment: block.settings.text_alignment,
                content_position: section.settings.content_vertical_position,
                content_position_mobile: section.settings.content_vertical_position_mobile,
                title_font_weight: section.settings.title_font_weight
              -%}
            </div>
          {%- endif -%}
        {%- endfor -%}
      </div>
      
      <!-- Collections Grid -->
      <div class="fr-collections-container{% if section.settings.half_overlap %} fr-collections--overlap{% endif %}"
           style="--overlap-desktop: {{ section.settings.overlap_offset_desktop }}px; --overlap-mobile: {{ section.settings.overlap_offset_mobile }}px;">
        <div class="fr-collections-inner" style="max-width: {{ section.settings.collections_max_width }}; margin: 0 auto; padding: 0 20px;">
          <div class="fr-collections-grid">
            {%- for block in section.blocks -%}
              {%- if block.type == 'collection_block' -%}
                <div class="fr-collection-card" 
                     data-trigger-id="{{ block.id }}"
                     {{ block.shopify_attributes }}>
                  
                  <a href="{{ block.settings.collection_link }}" 
                     class="fr-collection-link"
                     {% if block.settings.collection_link == blank %}role="button" tabindex="0"{% endif %}>
                    
                    <div class="fr-collection-media {% if section.settings.collection_image_format == 'natural' %}fr-media-natural{% endif %}">
                      {%- if block.settings.enable_product_animation and block.settings.collection != blank -%}
                        {%- assign collection = collections[block.settings.collection] -%}
                        {%- if collection.products.size > 0 -%}
                          <div class="fr-product-slider" 
                               data-speed="{{ block.settings.animation_speed }}"
                               data-type="{{ block.settings.animation_type }}">
                            {%- for product in collection.products limit: block.settings.max_products -%}
                              {%- if product.featured_image != blank -%}
                                <div class="fr-product-slide{% if forloop.first %} active{% endif %}">
                                  {%- render 'image-element',
                                    img: product.featured_image,
                                    img_width: 800,
                                    loading: true
                                  -%}
                                </div>
                              {%- endif -%}
                            {%- endfor -%}
                          </div>
                        {%- elsif block.settings.collection_image != blank -%}
                          {%- render 'image-element',
                            img: block.settings.collection_image,
                            img_width: 800,
                            loading: true
                          -%}
                        {%- else -%}
                          {{ 'collection-1' | placeholder_svg_tag: 'placeholder-svg' }}
                        {%- endif -%}
                      {%- elsif block.settings.collection_image != blank -%}
                        {%- render 'image-element',
                          img: block.settings.collection_image,
                          img_width: 800,
                          loading: true
                        -%}
                      {%- else -%}
                        {{ 'collection-1' | placeholder_svg_tag: 'placeholder-svg' }}
                      {%- endif -%}
                    </div>
                    
                    <div class="fr-collection-content">
                      {%- if block.settings.collection_title != blank -%}
                        <h3 class="fr-collection-title">
                          {{ block.settings.collection_title }}
                        </h3>
                      {%- endif -%}
                      {%- if block.settings.collection_subtitle != blank -%}
                        <span class="fr-collection-subtitle">
                          {{ block.settings.collection_subtitle }}
                        </span>
                      {%- endif -%}
                    </div>
                  </a>
                </div>
              {%- endif -%}
            {%- endfor -%}
          </div>
        </div>
      </div>
    </div>

    <style>
      /* Base Reset & Container */
      #shopify-section-{{ section.id }} {
        position: relative;
        background-color: {{ section.settings.section_bg_color }};
        overflow: visible;
      }

      #shopify-section-{{ section.id }} * {
        box-sizing: border-box;
      }

      /* Hero Wrapper */
      #shopify-section-{{ section.id }} .fr-hero-wrapper {
        position: relative;
        width: 100%;
      }

      /* Hero Media Container */
      #shopify-section-{{ section.id }} .fr-hero-media-container {
        position: relative;
        {%- if section.settings.desktop_height == '100vh-with-collections' -%}
          /* Height sarà calcolata da JavaScript per precisione */
          height: 70vh; /* Fallback height */
        {%- else -%}
          height: {{ section.settings.desktop_height }};
        {%- endif -%}
        overflow: hidden;
        background: #000;
      }
      
      /* Special case for 100vh with collections */
      {%- if section.settings.desktop_height == '100vh-with-collections' -%}
        @media only screen and (min-width: 769px) {
          #shopify-section-{{ section.id }} {
            min-height: 100vh;
            max-height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
          }
          
          #shopify-section-{{ section.id }} .fr-hero-wrapper {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
          }
          
          #shopify-section-{{ section.id }} .fr-hero-media-container {
            flex: 1 1 auto;
            position: relative;
          }
          
          #shopify-section-{{ section.id }} .fr-collections-container {
            flex-shrink: 0;
            position: relative;
            z-index: 15; /* Ensure collections are above hero for hover */
          }
          
          #shopify-section-{{ section.id }} .fr-collections-container.fr-collections--overlap {
            margin-top: calc(-1 * var(--overlap-desktop));
          }
          
          /* Ensure proper pointer events */
          #shopify-section-{{ section.id }} .fr-collection-card {
            pointer-events: auto;
            position: relative;
            z-index: 20;
          }
        }
      {%- endif -%}

      /* Hero Media Items */
      #shopify-section-{{ section.id }} .fr-hero-media {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        transition: opacity {{ section.settings.transition_duration }}ms cubic-bezier(0.4, 0, 0.2, 1);
      }

      #shopify-section-{{ section.id }} .fr-hero-media.active {
        opacity: 1;
        z-index: 2;
      }

      /* Images & Videos */
      #shopify-section-{{ section.id }} .fr-hero-image,
      #shopify-section-{{ section.id }} .fr-hero-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      #shopify-section-{{ section.id }} .fr-hero-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      #shopify-section-{{ section.id }} .fr-hero-video--mobile,
      #shopify-section-{{ section.id }} .fr-hero-image--mobile {
        display: none;
      }

      /* Overlay */
      #shopify-section-{{ section.id }} .fr-hero-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        pointer-events: none;
      }

      /* Link Overlay */
      #shopify-section-{{ section.id }} .fr-hero-link-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 5;
        cursor: pointer;
      }

      /* Collections Container - Desktop */
      #shopify-section-{{ section.id }} .fr-collections-container {
        position: relative;
        z-index: 10;
        padding: 60px 0;
        background: {{ section.settings.section_bg_color }};
      }
      
      #shopify-section-{{ section.id }} .fr-collections-inner {
        width: 100%;
      }

      #shopify-section-{{ section.id }} .fr-collections-container.fr-collections--overlap {
        margin-top: calc(-1 * var(--overlap-desktop));
        padding-top: 40px;
      }

      /* Collections Grid - Desktop Ottimizzato */
      #shopify-section-{{ section.id }} .fr-collections-grid {
        display: {% if section.settings.collections_layout == 'flex' %}flex{% else %}grid{% endif %};
        {%- if section.settings.collections_layout == 'flex' -%}
          justify-content: center;
          flex-wrap: wrap;
        {%- else -%}
          grid-template-columns: repeat({{ section.settings.collections_columns }}, minmax(0, 1fr));
        {%- endif -%}
        gap: {{ section.settings.collections_gap }}px;
        width: 100%;
        margin: 0 auto;
      }
      
      /* Collection Card con dimensione controllata */
      #shopify-section-{{ section.id }} .fr-collection-card {
        {%- if section.settings.collections_layout == 'flex' -%}
          width: {{ section.settings.collection_card_width }}px;
          flex: 0 0 auto;
          max-width: 100%;
        {%- else -%}
          width: 100%;
          min-width: 0;
        {%- endif -%}
        position: relative;
        transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        will-change: transform;
      }
      
      /* Center cards when fewer than expected */
      {%- if section.settings.collections_layout == 'grid' -%}
        #shopify-section-{{ section.id }} .fr-collections-grid:has(.fr-collection-card:only-child) {
          grid-template-columns: 1fr;
          max-width: min(400px, {{ section.settings.collections_max_width }});
        }
        
        #shopify-section-{{ section.id }} .fr-collections-grid:has(.fr-collection-card:nth-child(2):last-child) {
          grid-template-columns: repeat(2, minmax(0, 1fr));
          max-width: min(800px, {{ section.settings.collections_max_width }});
        }
      {%- endif -%}

      /* Collection Card */
      #shopify-section-{{ section.id }} .fr-collection-card {
        position: relative;
        transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        will-change: transform;
      }

      #shopify-section-{{ section.id }} .fr-collection-card:hover {
        transform: translateY(-8px);
      }

      #shopify-section-{{ section.id }} .fr-collection-link {
        display: block;
        position: relative;
        border-radius: {{ section.settings.card_border_radius }}px;
        overflow: hidden;
        background: #fff;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.06);
        transition: box-shadow 0.4s ease;
        text-decoration: none;
        height: 100%;
      }

      #shopify-section-{{ section.id }} .fr-collection-card:hover .fr-collection-link {
        box-shadow: 0 8px 32px rgba(0,0,0,0.12), 0 4px 16px rgba(0,0,0,0.08);
      }

      /* Collection Media - Con formato selezionabile */
      #shopify-section-{{ section.id }} .fr-collection-media {
        position: relative;
        width: 100%;
        overflow: hidden;
        background: #f5f5f5;
        {%- case section.settings.collection_image_format -%}
          {%- when 'natural' -%}
            /* Natural format - no fixed aspect ratio */
          {%- when 'square' -%}
            padding-bottom: 100%;
          {%- when 'portrait' -%}
            padding-bottom: 133.33%;
          {%- when 'landscape' -%}
            padding-bottom: 75%;
          {%- when 'wide' -%}
            padding-bottom: 56.25%;
        {%- endcase -%}
      }

      /* Natural format specific styles */
      #shopify-section-{{ section.id }} .fr-collection-media.fr-media-natural {
        padding-bottom: 0;
      }

      #shopify-section-{{ section.id }} .fr-collection-media.fr-media-natural img,
      #shopify-section-{{ section.id }} .fr-collection-media.fr-media-natural .placeholder-svg {
        position: relative;
        width: 100%;
        height: auto;
        display: block;
      }

      /* Non-natural format styles */
      #shopify-section-{{ section.id }} .fr-collection-media:not(.fr-media-natural) img,
      #shopify-section-{{ section.id }} .fr-collection-media:not(.fr-media-natural) .placeholder-svg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      #shopify-section-{{ section.id }} .fr-collection-media img,
      #shopify-section-{{ section.id }} .fr-collection-media .placeholder-svg {
        transition: transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      }

      #shopify-section-{{ section.id }} .fr-collection-card:hover .fr-collection-media img {
        transform: scale(1.08);
      }

      /* Product Slider */
      #shopify-section-{{ section.id }} .fr-product-slider {
        {%- if section.settings.collection_image_format == 'natural' -%}
          position: relative;
          width: 100%;
        {%- else -%}
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
        {%- endif -%}
      }

      #shopify-section-{{ section.id }} .fr-product-slide {
        {%- if section.settings.collection_image_format == 'natural' -%}
          display: none;
        {%- else -%}
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          opacity: 0;
        {%- endif -%}
        transition: opacity 1s ease;
      }

      #shopify-section-{{ section.id }} .fr-product-slide.active {
        {%- if section.settings.collection_image_format == 'natural' -%}
          display: block;
        {%- else -%}
          opacity: 1;
        {%- endif -%}
      }

      #shopify-section-{{ section.id }} .fr-product-slide img {
        width: 100%;
        {%- if section.settings.collection_image_format == 'natural' -%}
          height: auto;
        {%- else -%}
          height: 100%;
          object-fit: cover;
        {%- endif -%}
      }

      /* Collection Content */
      #shopify-section-{{ section.id }} .fr-collection-content {
        {%- if section.settings.collections_layout == 'flex' -%}
          padding: {% if section.settings.collection_card_width < 280 %}16px{% else %}24px{% endif %};
        {%- else -%}
          padding: 20px;
        {%- endif -%}
        background: linear-gradient(to bottom, #fff, #fafafa);
        text-align: center;
      }

      #shopify-section-{{ section.id }} .fr-collection-title {
        {%- if section.settings.collections_layout == 'flex' -%}
          font-size: {% if section.settings.collection_card_width < 280 %}20px{% elsif section.settings.collection_card_width < 350 %}22px{% else %}24px{% endif %};
        {%- else -%}
          font-size: clamp(18px, 2vw, 24px);
        {%- endif -%}
        font-weight: 600;
        color: #3E3E3E;
        margin: 0 0 8px;
        letter-spacing: -0.02em;
        line-height: 1.2;
      }

      #shopify-section-{{ section.id }} .fr-collection-subtitle {
        {%- if section.settings.collections_layout == 'flex' -%}
          font-size: {% if section.settings.collection_card_width < 280 %}13px{% elsif section.settings.collection_card_width < 350 %}14px{% else %}15px{% endif %};
        {%- else -%}
          font-size: clamp(12px, 1.5vw, 15px);
        {%- endif -%}
        color: #B5A397;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-weight: 500;
      }

      /* Mobile Ottimizzato */
      @media only screen and (max-width: 768px) {
        #shopify-section-{{ section.id }} .fr-hero-media-container {
          height: {{ section.settings.mobile_height }};
        }

        #shopify-section-{{ section.id }} .fr-hero-video {
          display: none;
        }

        #shopify-section-{{ section.id }} .fr-hero-video--mobile {
          display: block;
        }

        #shopify-section-{{ section.id }} .fr-hero-image--desktop {
          display: none;
        }

        #shopify-section-{{ section.id }} .fr-hero-image--mobile {
          display: block;
        }

        /* Collections Mobile Ottimizzato */
        #shopify-section-{{ section.id }} .fr-collections-container {
          padding: 40px 0;
        }

        #shopify-section-{{ section.id }} .fr-collections-container.fr-collections--overlap {
          margin-top: calc(-1 * var(--overlap-mobile));
          padding-top: 20px;
        }

        #shopify-section-{{ section.id }} .fr-collections-grid {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 16px;
        }
        
        #shopify-section-{{ section.id }} .fr-collection-card {
          width: 100% !important;
          flex: unset !important;
          max-width: 100% !important;
        }

        /* Se c'è solo 1 elemento */
        #shopify-section-{{ section.id }} .fr-collections-grid:has(.fr-collection-card:only-child) {
          grid-template-columns: 1fr;
          max-width: 400px;
          margin: 0 auto;
        }

        /* Se ci sono 3 elementi - OTTIMIZZATO per essere ben visibile */
        #shopify-section-{{ section.id }} .fr-collection-card:nth-child(3):nth-last-child(1) {
          grid-column: 1 / -1;
          justify-self: center;
          width: calc(50% - 8px);
          max-width: 300px;
        }

        /* Mobile specific aspect ratio adjustment */
        #shopify-section-{{ section.id }} .fr-collection-media:not(.fr-media-natural) {
          {%- case section.settings.collection_image_format_mobile -%}
            {%- when 'square' -%}
              padding-bottom: 100%;
            {%- when 'portrait' -%}
              padding-bottom: 133.33%;
            {%- when 'landscape' -%}
              padding-bottom: 75%;
            {%- when 'wide' -%}
              padding-bottom: 56.25%;
            {%- else -%}
              /* Mantieni formato desktop se non specificato */
          {%- endcase -%}
        }

        #shopify-section-{{ section.id }} .fr-collection-content {
          padding: 16px;
        }

        #shopify-section-{{ section.id }} .fr-collection-title {
          font-size: 18px;
          margin-bottom: 4px;
        }

        #shopify-section-{{ section.id }} .fr-collection-subtitle {
          font-size: 12px;
        }

        /* Touch Optimization */
        #shopify-section-{{ section.id }} .fr-collection-card:active {
          transform: scale(0.98);
        }

        #shopify-section-{{ section.id }} .fr-collection-card:hover {
          transform: none;
        }
      }

      /* Tablet */
      @media only screen and (min-width: 769px) and (max-width: 1024px) {
        #shopify-section-{{ section.id }} .fr-collections-grid {
          {%- if section.settings.collections_layout == 'flex' -%}
            justify-content: center;
          {%- else -%}
            grid-template-columns: repeat(min(3, {{ section.settings.collections_columns }}), 1fr);
          {%- endif -%}
          gap: 20px;
        }
        
        {%- if section.settings.collections_layout == 'flex' -%}
          #shopify-section-{{ section.id }} .fr-collection-card {
            width: min({{ section.settings.collection_card_width }}px, 300px);
            flex: 0 0 auto;
          }
        {%- endif -%}
      }

      /* Desktop Large */
      @media only screen and (min-width: 1400px) {
        /* Additional styles for large screens if needed */
      }
      
      /* Responsive adjustments for large cards */
      @media only screen and (min-width: 769px) {
        {%- if section.settings.collections_layout == 'flex' -%}
          #shopify-section-{{ section.id }} .fr-collections-grid {
            justify-content: center;
          }
        {%- endif -%}
      }

      /* Spacing Controls */
      @media only screen and (min-width: 769px) {
        #shopify-section-{{ section.id }} {
          max-width: {{ section.settings.max_dimensione }};
          margin: 0 auto;
          padding-top: {{ section.settings.padding_top_desktop }}px;
          padding-bottom: {{ section.settings.padding_bottom_desktop }}px;
          margin-top: {{ section.settings.margin_top_desktop }}px;
          margin-bottom: {{ section.settings.margin_bottom_desktop }}px;
        }

        {% if section.settings.nascondi_desktop %}
          #shopify-section-{{ section.id }} {
            display: none;
          }
        {% endif %}
      }

      @media only screen and (max-width: 768px) {
        #shopify-section-{{ section.id }} {
          padding-top: {{ section.settings.padding_top_mobile }}px;
          padding-bottom: {{ section.settings.padding_bottom_mobile }}px;
          margin-top: {{ section.settings.margin_top_mobile }}px;
          margin-bottom: {{ section.settings.margin_bottom_mobile }}px;
        }

        {% if section.settings.nascondi_mobile %}
          #shopify-section-{{ section.id }} {
            display: none;
          }
        {% endif %}
      }
    </style>

    <script>
      (function() {
        const sectionId = '{{ section.id }}';
        const section = document.querySelector(`[data-section-id="${sectionId}"]`);
        if (!section) return;

        const isMobile = window.innerWidth <= 768;

        // Product Slider Animation
        function initProductSliders() {
          const sliders = section.querySelectorAll('.fr-product-slider');
          
          sliders.forEach(slider => {
            const slides = slider.querySelectorAll('.fr-product-slide');
            if (slides.length <= 1) return;
            
            const speed = parseFloat(slider.dataset.speed) || 3;
            let currentSlide = 0;
            
            setInterval(() => {
              slides[currentSlide].classList.remove('active');
              currentSlide = (currentSlide + 1) % slides.length;
              slides[currentSlide].classList.add('active');
            }, speed * 1000);
          });
        }

        // Hero Image Change on Hover (Desktop only)
        function setupHoverInteractions() {
          if (isMobile) return;

          // Query elements fresh each time
          const currentCards = section.querySelectorAll('.fr-collection-card');
          const currentMediaElements = section.querySelectorAll('.fr-hero-media');
          const currentDefaultMedia = section.querySelector('[data-media-id="default"]');
          
          if (currentCards.length === 0) {
            // If cards not ready, retry
            setTimeout(setupHoverInteractions, 200);
            return;
          }
          
          currentCards.forEach(card => {
            const triggerId = card.dataset.triggerId;
            const targetMedia = section.querySelector(`[data-media-id="${triggerId}"]`);
            
            if (!targetMedia) return;
            
            // Clean way to add event listeners without duplicates
            if (!card.hasAttribute('data-hover-initialized')) {
              card.setAttribute('data-hover-initialized', 'true');
              
              card.addEventListener('mouseenter', function() {
                currentMediaElements.forEach(media => media.classList.remove('active'));
                targetMedia.classList.add('active');
              });

              card.addEventListener('mouseleave', function() {
                if (currentDefaultMedia) {
                  currentMediaElements.forEach(media => media.classList.remove('active'));
                  currentDefaultMedia.classList.add('active');
                }
              });
            }
          });
        }

        // Initialize Product Sliders
        initProductSliders();
        
        // Setup based on configuration
        {%- if section.settings.desktop_height == '100vh-with-collections' -%}
        if (!isMobile) {
          const initFullscreenWithCollections = () => {
            // First adjust layout
            const heroWrapper = section.querySelector('.fr-hero-wrapper');
            const collectionsContainer = section.querySelector('.fr-collections-container');
            const mediaContainer = section.querySelector('.fr-hero-media-container');
            
            if (heroWrapper && collectionsContainer && mediaContainer) {
              const collectionsHeight = collectionsContainer.offsetHeight;
              const overlap = {{ section.settings.overlap_offset_desktop }};
              const viewportHeight = window.innerHeight;
              
              // Calculate hero height accounting for overlap
              const heroHeight = viewportHeight - (collectionsHeight - overlap);
              
              // Apply the calculated height
              mediaContainer.style.height = `${heroHeight}px`;
              heroWrapper.style.height = `${viewportHeight}px`;
            }
            
            // Then setup hover interactions after DOM is settled
            setTimeout(setupHoverInteractions, 100);
          };
          
          // Use both DOMContentLoaded and load to ensure everything is ready
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initFullscreenWithCollections);
          } else {
            // DOM already loaded, wait for images
            if (document.readyState === 'complete') {
              initFullscreenWithCollections();
            } else {
              window.addEventListener('load', initFullscreenWithCollections);
            }
          }
          
          // Handle resize
          let resizeTimer;
          window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(initFullscreenWithCollections, 100);
          });
        }
        {%- else -%}
        // Normal initialization
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', setupHoverInteractions);
        } else {
          setupHoverInteractions();
        }
        {%- endif -%}

        // Reinitialize on resize (debounced)
        let resizeTimer;
        window.addEventListener('resize', () => {
          clearTimeout(resizeTimer);
          resizeTimer = setTimeout(() => {
            const newIsMobile = window.innerWidth <= 768;
            if (newIsMobile !== isMobile && !window.Shopify?.designMode) {
              location.reload();
            }
          }, 250);
        });
      })();
    </script>
    {%- endif -%}
  {%- endif -%}

  {%- if section.blocks.size == 0 -%}
    <div class="placeholder-noblocks" style="padding: 80px 20px; text-align: center; background: {{ section.settings.section_bg_color }};">
      <h2>{{ 'home_page.onboarding.no_content' | t }}</h2>
    </div>
  {%- endif -%}
</div>

{%- comment -%} Hero Content Snippet - da creare in snippets/hero-content.liquid {%- endcomment -%}
{%- comment -%}
  Nel file snippets/hero-content.liquid inserire:
  
  <div class="fr-hero-content" style="--content-position-desktop: {{ content_position }}%; --content-position-mobile: {{ content_position_mobile }}%;">
    <div class="page-width">
      <div class="fr-hero-text-wrapper {{ text_alignment | default: 'text-center' }}">
        {%- if title != blank -%}
          <h2 class="fr-hero-title" style="color: {{ text_color | default: '#FFFFFF' }}; font-weight: {{ title_font_weight | default: 600 }};">
            {{ title | newline_to_br }}
          </h2>
        {%- endif -%}
        
        {%- if subtitle != blank -%}
          <div class="fr-hero-subtitle" style="color: {{ text_color | default: '#FFFFFF' }};">
            {{ subtitle }}
          </div>
        {%- endif -%}
        
        {%- if cta_text != blank and cta_link != blank and link_type != 'background' -%}
          <div class="fr-hero-cta">
            <a href="{{ cta_link }}" 
               class="btn {{ cta_style }}"
               style="
                 {%- if cta_bg_color != blank -%}background-color: {{ cta_bg_color }};{%- endif -%}
                 {%- if cta_text_color != blank -%}color: {{ cta_text_color }};{%- endif -%}
                 {%- if cta_border_color != blank -%}border-color: {{ cta_border_color }};{%- endif -%}
               ">
              {{ cta_text }}
            </a>
          </div>
        {%- endif -%}
      </div>
    </div>
  </div>

  <style>
    .fr-hero-content {
      position: absolute;
      top: var(--content-position-desktop, 50%);
      left: 0;
      width: 100%;
      transform: translateY(-50%);
      z-index: 3;
      pointer-events: none;
      padding: 0 20px;
    }
    
    @media screen and (max-width: 768px) {
      .fr-hero-content {
        top: var(--content-position-mobile, 50%);
      }
    }
    
    .fr-hero-text-wrapper {
      max-width: 900px;
      margin: 0 auto;
    }
    
    .fr-hero-title {
      font-size: clamp(32px, 5vw, 60px);
      line-height: 1.1;
      margin: 0 0 20px;
      text-shadow: 0 2px 20px rgba(0,0,0,0.3);
    }
    
    .fr-hero-subtitle {
      font-size: clamp(16px, 2vw, 20px);
      line-height: 1.5;
      margin-bottom: 30px;
      text-shadow: 0 1px 10px rgba(0,0,0,0.3);
    }
    
    .fr-hero-cta {
      pointer-events: auto;
      margin-top: 30px;
    }
    
    .fr-hero-cta .btn {
      padding: 14px 40px;
      font-size: 16px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-radius: 4px;
      transition: all 0.3s ease;
      display: inline-block;
      text-decoration: none;
    }
    
    .fr-hero-cta .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    
    .text-left { text-align: left; }
    .text-center { text-align: center; }
    .text-right { text-align: right; }
  </style>
{%- endcomment -%}

{% schema %}
{
  "name": "Hero Interactive",
  "class": "fr-hero-collections",
  "max_blocks": 6,
  "settings": [
    {
      "type": "header",
      "content": "Media di Default"
    },
    {
      "type": "image_picker",
      "id": "default_image",
      "label": "Immagine desktop"
    },
    {
      "type": "image_picker",
      "id": "default_image_mobile",
      "label": "Immagine mobile"
    },
    {
      "type": "video",
      "id": "default_video",
      "label": "Video desktop"
    },
    {
      "type": "video",
      "id": "default_video_mobile",
      "label": "Video mobile"
    },
    {
      "type": "range",
      "id": "default_overlay_opacity",
      "label": "Opacità overlay",
      "min": 0,
      "max": 80,
      "step": 5,
      "default": 20,
      "unit": "%"
    },
    {
      "type": "header",
      "content": "Contenuto Hero"
    },
    {
      "type": "textarea",
      "id": "default_title",
      "label": "Titolo",
      "default": "Benvenuti da\nFabindia Roma"
    },
    {
      "type": "text",
      "id": "default_subtitle",
      "label": "Sottotitolo",
      "default": "Scopri l'autentico artigianato indiano"
    },
    {
      "type": "select",
      "id": "default_text_alignment",
      "label": "Allineamento testo",
      "options": [
        {
          "value": "text-left",
          "label": "Sinistra"
        },
        {
          "value": "text-center",
          "label": "Centro"
        },
        {
          "value": "text-right",
          "label": "Destra"
        }
      ],
      "default": "text-center"
    },
    {
      "type": "color",
      "id": "default_text_color",
      "label": "Colore testo",
      "default": "#FFFFFF"
    },
    {
      "type": "select",
      "id": "title_font_weight",
      "label": "Peso font titoli",
      "options": [
        {
          "value": "300",
          "label": "Light"
        },
        {
          "value": "400",
          "label": "Regular"
        },
        {
          "value": "500",
          "label": "Medium"
        },
        {
          "value": "600",
          "label": "Semi Bold"
        },
        {
          "value": "700",
          "label": "Bold"
        },
        {
          "value": "800",
          "label": "Extra Bold"
        }
      ],
      "default": "600"
    },
    {
      "type": "header",
      "content": "Call to Action"
    },
    {
      "type": "url",
      "id": "default_link",
      "label": "Link"
    },
    {
      "type": "select",
      "id": "link_type",
      "label": "Tipo di link",
      "options": [
        {
          "value": "background",
          "label": "Sfondo cliccabile"
        },
        {
          "value": "button",
          "label": "Solo pulsante"
        },
        {
          "value": "both",
          "label": "Entrambi"
        }
      ],
      "default": "button"
    },
    {
      "type": "text",
      "id": "cta_text",
      "label": "Testo pulsante",
      "default": "Scopri di più"
    },
    {
      "type": "select",
      "id": "cta_style",
      "label": "Stile pulsante",
      "options": [
        {
          "value": "btn--primary",
          "label": "Primario"
        },
        {
          "value": "btn--secondary",
          "label": "Secondario"
        },
        {
          "value": "btn--outline",
          "label": "Outline"
        }
      ],
      "default": "btn--primary"
    },
    {
      "type": "color",
      "id": "cta_bg_color",
      "label": "Colore sfondo CTA",
      "default": "#C33A32"
    },
    {
      "type": "color",
      "id": "cta_text_color",
      "label": "Colore testo CTA",
      "default": "#FFFFFF"
    },
    {
      "type": "color",
      "id": "cta_border_color",
      "label": "Colore bordo CTA",
      "default": "#C33A32"
    },
    {
      "type": "header",
      "content": "Posizione Contenuto"
    },
    {
      "type": "range",
      "id": "content_vertical_position",
      "label": "Posizione Desktop",
      "min": 10,
      "max": 90,
      "step": 5,
      "default": 50,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "content_vertical_position_mobile",
      "label": "Posizione Mobile",
      "min": 10,
      "max": 90,
      "step": 5,
      "default": 50,
      "unit": "%"
    },
    {
      "type": "header",
      "content": "Dimensioni"
    },
    {
      "type": "select",
      "id": "desktop_height",
      "label": "Altezza desktop",
      "options": [
        {
          "value": "350px",
          "label": "Extra piccola (350px)"
        },
        {
          "value": "450px",
          "label": "Piccola (450px)"
        },
        {
          "value": "500px",
          "label": "Media-piccola (500px)"
        },
        {
          "value": "550px",
          "label": "Media (550px)"
        },
        {
          "value": "600px",
          "label": "Media-grande (600px)"
        },
        {
          "value": "650px",
          "label": "Grande (650px)"
        },
        {
          "value": "700px",
          "label": "Extra grande (700px)"
        },
        {
          "value": "750px",
          "label": "XXL (750px)"
        },
        {
          "value": "80vh",
          "label": "80% schermo"
        },
        {
          "value": "90vh",
          "label": "90% schermo"
        },
        {
          "value": "100vh",
          "label": "Schermo intero"
        },
        {
          "value": "100vh-with-collections",
          "label": "Schermo intero con collezioni"
        }
      ],
      "default": "650px",
      "info": "'Schermo intero con collezioni' include le card nel viewport"
    },
    {
      "type": "select",
      "id": "mobile_height",
      "label": "Altezza mobile",
      "options": [
        {
          "value": "350px",
          "label": "Piccola"
        },
        {
          "value": "450px",
          "label": "Media"
        },
        {
          "value": "550px",
          "label": "Grande"
        },
        {
          "value": "100vh",
          "label": "Schermo intero"
        }
      ],
      "default": "450px"
    },
    {
      "type": "header",
      "content": "Layout Collezioni"
    },
    {
      "type": "checkbox",
      "id": "half_overlap",
      "label": "Sovrapponi collezioni",
      "default": true
    },
    {
      "type": "range",
      "id": "overlap_offset_desktop",
      "label": "Sovrapposizione Desktop",
      "min": 0,
      "max": 2000,
      "step": 25,
      "default": 100,
      "unit": "px",
      "info": "Quanto le collezioni si sovrappongono all'hero su desktop"
    },
    {
      "type": "range",
      "id": "overlap_offset_mobile",
      "label": "Sovrapposizione Mobile",
      "min": 0,
      "max": 300,
      "step": 10,
      "default": 60,
      "unit": "px",
      "info": "Quanto le collezioni si sovrappongono all'hero su mobile"
    },
    {
      "type": "header",
      "content": "Dimensioni Collezioni"
    },
    {
      "type": "select",
      "id": "collections_layout",
      "label": "Tipo di layout",
      "options": [
        {
          "value": "grid",
          "label": "Griglia (responsive)"
        },
        {
          "value": "flex",
          "label": "Flex (dimensione fissa)"
        }
      ],
      "default": "flex",
      "info": "Flex: controllo preciso dimensioni. Griglia: card responsive"
    },
    {
      "type": "range",
      "id": "collection_card_width",
      "label": "Larghezza card",
      "min": 200,
      "max": 500,
      "step": 10,
      "default": 340,
      "unit": "px",
      "info": "Attivo solo con layout Flex. Imposta la larghezza esatta delle card"
    },
    {
      "type": "select",
      "id": "collections_columns",
      "label": "Numero colonne",
      "options": [
        {
          "value": "2",
          "label": "2 colonne"
        },
        {
          "value": "3",
          "label": "3 colonne"
        },
        {
          "value": "4",
          "label": "4 colonne"
        },
        {
          "value": "5",
          "label": "5 colonne"
        }
      ],
      "default": "3",
      "info": "Attivo solo con layout Griglia. Le card si adattano alla larghezza disponibile"
    },
    {
      "type": "range",
      "id": "collections_gap",
      "label": "Spazio tra card",
      "min": 10,
      "max": 50,
      "step": 5,
      "default": 30,
      "unit": "px"
    },
    {
      "type": "select",
      "id": "collections_max_width",
      "label": "Larghezza container",
      "options": [
        {
          "value": "900px",
          "label": "Molto compatto (900px)"
        },
        {
          "value": "1100px",
          "label": "Compatto (1100px)"
        },
        {
          "value": "1300px",
          "label": "Standard (1300px)"
        },
        {
          "value": "1500px",
          "label": "Largo (1500px)"
        },
        {
          "value": "1700px",
          "label": "Extra largo (1700px)"
        },
        {
          "value": "100%",
          "label": "Piena larghezza"
        }
      ],
      "default": "1300px"
    },
    {
      "type": "range",
      "id": "collections_viewport_height",
      "label": "Spazio collezioni (100vh)",
      "min": 150,
      "max": 400,
      "step": 10,
      "default": 250,
      "unit": "px",
      "info": "Attivo solo con 'Schermo intero con collezioni'. Spazio riservato alle card nel viewport"
    },
    {
      "type": "select",
      "id": "collection_image_format",
      "label": "Formato immagini Desktop",
      "options": [
        {
          "value": "natural",
          "label": "Naturale (come l'immagine)"
        },
        {
          "value": "square",
          "label": "Quadrato (1:1)"
        },
        {
          "value": "portrait",
          "label": "Ritratto (3:4)"
        },
        {
          "value": "landscape",
          "label": "Paesaggio (4:3)"
        },
        {
          "value": "wide",
          "label": "Wide (16:9)"
        }
      ],
      "default": "natural",
      "info": "Scegli 'Naturale' per mantenere le proporzioni originali"
    },
    {
      "type": "select",
      "id": "collection_image_format_mobile",
      "label": "Formato immagini Mobile",
      "options": [
        {
          "value": "same",
          "label": "Come desktop"
        },
        {
          "value": "square",
          "label": "Quadrato (1:1)"
        },
        {
          "value": "portrait",
          "label": "Ritratto (3:4)"
        },
        {
          "value": "landscape",
          "label": "Paesaggio (4:3)"
        },
        {
          "value": "wide",
          "label": "Wide (16:9)"
        }
      ],
      "default": "same"
    },
    {
      "type": "range",
      "id": "card_border_radius",
      "label": "Raggio bordi",
      "min": 0,
      "max": 20,
      "step": 2,
      "default": 8,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "transition_duration",
      "label": "Durata transizione",
      "min": 300,
      "max": 1000,
      "step": 100,
      "default": 600,
      "unit": "ms"
    },
    {
      "type": "header",
      "content": "Colori"
    },
    {
      "type": "color",
      "id": "section_bg_color",
      "label": "Sfondo sezione",
      "default": "#FEFEFE"
    },
    {
      "type": "checkbox",
      "id": "nascondi_mobile",
      "label": "Nascondi su Mobile",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "nascondi_desktop",
      "label": "Nascondi su Desktop",
      "default": false
    },
    {
      "type": "range",
      "id": "padding_top_mobile",
      "label": "Padding Top Mobile",
      "min": 0,
      "max": 100,
      "step": 1,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom_mobile",
      "label": "Padding Bottom Mobile",
      "min": 0,
      "max": 100,
      "step": 1,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_top_desktop",
      "label": "Padding Top Desktop",
      "min": 0,
      "max": 200,
      "step": 2,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom_desktop",
      "label": "Padding Bottom Desktop",
      "min": 0,
      "max": 200,
      "step": 2,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "margin_top_mobile",
      "label": "Margin Top Mobile",
      "min": -100,
      "max": 100,
      "step": 2,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "margin_bottom_mobile",
      "label": "Margin Bottom Mobile",
      "min": -100,
      "max": 100,
      "step": 2,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "margin_top_desktop",
      "label": "Margin Top Desktop",
      "min": -200,
      "max": 200,
      "step": 4,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "margin_bottom_desktop",
      "label": "Margin Bottom Desktop",
      "min": -200,
      "max": 200,
      "step": 4,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "select",
      "id": "max_dimensione",
      "label": "Larghezza Massima",
      "options": [
        {
          "value": "none",
          "label": "100%"
        },
        {
          "value": "1400px",
          "label": "1400px"
        },
        {
          "value": "1300px",
          "label": "1300px"
        },
        {
          "value": "1200px",
          "label": "1200px"
        },
        {
          "value": "1100px",
          "label": "1100px"
        },
        {
          "value": "1000px",
          "label": "1000px"
        },
        {
          "value": "900px",
          "label": "900px"
        },
        {
          "value": "800px",
          "label": "800px"
        },
        {
          "value": "700px",
          "label": "700px"
        }
      ],
      "default": "none"
    }
  ],
  "blocks": [
    {
      "type": "collection_block",
      "name": "Collezione",
      "settings": [
        {
          "type": "header",
          "content": "Immagine Hero"
        },
        {
          "type": "image_picker",
          "id": "hero_image",
          "label": "Immagine desktop"
        },
        {
          "type": "image_picker",
          "id": "hero_image_mobile",
          "label": "Immagine mobile"
        },
        {
          "type": "range",
          "id": "overlay_opacity",
          "label": "Opacità overlay",
          "min": 0,
          "max": 80,
          "step": 5,
          "default": 20,
          "unit": "%"
        },
        {
          "type": "textarea",
          "id": "hero_title",
          "label": "Titolo hero"
        },
        {
          "type": "text",
          "id": "hero_subtitle",
          "label": "Sottotitolo hero"
        },
        {
          "type": "select",
          "id": "text_alignment",
          "label": "Allineamento",
          "options": [
            {
              "value": "text-left",
              "label": "Sinistra"
            },
            {
              "value": "text-center",
              "label": "Centro"
            },
            {
              "value": "text-right",
              "label": "Destra"
            }
          ],
          "default": "text-center"
        },
        {
          "type": "color",
          "id": "hero_text_color",
          "label": "Colore testo",
          "default": "#FFFFFF"
        },
        {
          "type": "header",
          "content": "Card Collezione"
        },
        {
          "type": "image_picker",
          "id": "collection_image",
          "label": "Immagine card"
        },
        {
          "type": "text",
          "id": "collection_title",
          "label": "Titolo"
        },
        {
          "type": "text",
          "id": "collection_subtitle",
          "label": "Sottotitolo"
        },
        {
          "type": "url",
          "id": "collection_link",
          "label": "Link"
        },
        {
          "type": "header",
          "content": "Animazione Prodotti"
        },
        {
          "type": "checkbox",
          "id": "enable_product_animation",
          "label": "Abilita slider",
          "default": false
        },
        {
          "type": "collection",
          "id": "collection",
          "label": "Collezione"
        },
        {
          "type": "select",
          "id": "animation_type",
          "label": "Tipo animazione",
          "options": [
            {
              "value": "fade",
              "label": "Dissolvenza"
            },
            {
              "value": "slide",
              "label": "Scorrimento"
            }
          ],
          "default": "fade"
        },
        {
          "type": "range",
          "id": "animation_speed",
          "label": "Velocità",
          "min": 1,
          "max": 10,
          "step": 0.5,
          "default": 3,
          "unit": "s"
        },
        {
          "type": "range",
          "id": "max_products",
          "label": "Max prodotti",
          "min": 2,
          "max": 10,
          "step": 1,
          "default": 6
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Hero Interactive",
      "category": "Fabindia custom"
    }
  ]
}
{% endschema %}